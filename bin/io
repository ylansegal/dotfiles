#!/usr/bin/env bash
# Prints stdin and executes in the given program, commenting the output.
# Example usage:

# $ echo "SELECT NOW()" | io psql procore_development
# SELECT NOW()
#
# --               now
# -- -------------------------------
# --  2019-02-05 12:43:19.756974-08
# -- (1 row)
# --
# -- Time: 0.737 ms

# $ echo "puts Time.now" | io ruby
# puts Time.now
#
# # 2019-02-05 12:42:58 -0800

set -euo pipefail

# Create a new temporary named pipe
fifoname=$(mktemp -u).fifo
mkfifo $fifoname

# Determine which comment pattern to use
case $1 in
      psql)
        comment='-- ' ;;
      *)
        comment='# ' ;;
esac

# Execute same command that was passed in, capture input and output with preceeding comments
tee $fifoname < /dev/stdin | cat - <(echo) <(cat $fifoname | "$@" | sed "s/^/$comment/")

# Delete named pipe
rm $fifoname
