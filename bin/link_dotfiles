#!/usr/bin/env bash
set -euo pipefail

# Link missing dotfiles so they are picked up form ~/.*

# Link dotfiles
ls ~/.dotfiles | \
  grep -v Brewfile | \
  grep -v LICENSE.txt | \
  grep -v README.md | \
  grep -v ylansegal.zsh-theme | \
  grep -v default-gems | \
  grep -v spectacle_shortcuts.json | \
  {
    while read rc_file; do
      if [ "$(readlink ~/.$rc_file)" -ef "$HOME/.dotfiles/$rc_file" ]; then
        echo "Skipping ~/.$rc_file, it's already linked"
      else
        if [ -e ~/.$rc_file ]; then
          mv ~/.$rc_file ~/.$rc_file.backup && echo "Moved ~/.$rc_file to ~/.$rc_file.backup"
        fi
        ln -s $HOME/.dotfiles/$rc_file $HOME/.$rc_file && echo "Linked ~/.$rc_file"
      fi
    done
  }

# Link oh-my-zsh theme
if [ -e $HOME/.oh-my-zsh/custom/themes/ylansegal.zsh-theme ]; then
  echo "Skipping ylansegal.zsh-theme, it already exists"
else
  mkdir -p $HOME/.oh-my-zsh/custom/themes
  ln -s $HOME/.dotfiles/ylansegal.zsh-theme $HOME/.oh-my-zsh/custom/themes/ylansegal.zsh-theme && \
    echo "Linked ylansegal.zsh-theme"
fi

# Link default-gems
if [ -e $(rbenv root)/default-gems ]; then
  echo "Skipping default-gems, it already exists"
else
  ln -s $HOME/.dotfiles/default-gems "$(rbenv root)/default-gems" && \
    echo "Linked default-gems"
fi

# Link Spectacle shortcuts file
SPECTACLES_DIR="$HOME/Library/Application Support/Spectacle"
if [ "$(readlink $SPECTACLES_DIR/Shortcuts.json)" -ef "$HOME/.dotfiles/spectacle_shortcuts.json" ]; then
  echo "Skipping $SPECTACLES_DIR/Shortcuts.json, it's already linked"
else
  if [ -e "$SPECTACLES_DIR/Shortcuts.json" ]; then
    mv "$SPECTACLES_DIR/Shortcuts.json" "$SPECTACLES_DIR/Shortcuts.json.backup"
    echo "Moved $SPECTACLES_DIR/Shortcuts.json to $SPECTACLES_DIR/Shortcuts.json.backup"
  fi
  ln -s $HOME/.dotfiles/spectacle_shortcuts.json "$SPECTACLES_DIR/Shortcuts.json" && echo "$SPECTACLES_DIR/Shortcuts.json"
fi
